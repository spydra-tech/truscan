rules:
  # ============================================================================
  # LLM06: Sensitive Information Disclosure
  # ============================================================================
  # Detects vulnerabilities where query engine responses or index content
  # are logged or exposed without sanitization
  # 
  # Usage with AI:
  #   python -m llm_scan.runner . --enable-ai-filter \
  #     --ai-analyze-rules llamaindex-llm06-query-engine-logging \
  #     --ai-analyze-rules llamaindex-llm06-index-content-logging
  #
  # OWASP: LLM06
  # CWE: CWE-200, CWE-532
  # ============================================================================

  - id: llamaindex-llm06-query-engine-logging
    patterns:
      - pattern-either:
          # Query engine response logging
          - pattern: |
              $RESPONSE = $QUERY_ENGINE.query(...)
              ...
              logger.info($RESPONSE)
          - pattern: |
              $RESPONSE = $QUERY_ENGINE.query(...)
              ...
              logger.debug($RESPONSE)
          - pattern: |
              $RESPONSE = $QUERY_ENGINE.query(...)
              ...
              logger.warning($RESPONSE)
          - pattern: |
              $RESPONSE = $QUERY_ENGINE.query(...)
              ...
              logger.error($RESPONSE)
          - pattern: |
              $RESPONSE = $QUERY_ENGINE.query(...)
              ...
              print($RESPONSE)
          - pattern: |
              $RESPONSE = $QUERY_ENGINE.query(...)
              ...
              sys.stdout.write($RESPONSE)
          - pattern: |
              $RESPONSE = $QUERY_ENGINE.retrieve(...)
              ...
              logger.info($RESPONSE)
    message: "LLM06: Sensitive Information Disclosure - Query engine response logged without sanitization"
    severity: WARNING
    languages: [python]
    metadata:
      category: security
      subcategory: data-exposure
      owasp: "LLM06"
      owasp-title: "Sensitive Information Disclosure"
      owasp-url: "https://owasp.org/www-project-top-10-for-large-language-model-applications/LLM_Top_10/LLM06.html"
      cwe: ["CWE-200", "CWE-532"]
      cwe-url: ["https://cwe.mitre.org/data/definitions/200.html", "https://cwe.mitre.org/data/definitions/532.html"]
      tags: ["owasp", "llm06", "sensitive-info-disclosure", "logging", "query-engine", "llamaindex", "ai-enhanced"]
      technology: ["python", "llamaindex", "llm"]
      confidence: "medium"  # Medium confidence - depends on what's logged
      impact: "medium"
      likelihood: "medium"  # AI will assess if sensitive data is present
      description: "Query engine response is logged without sanitization. If responses contain sensitive data (PII, secrets, API keys), this can lead to information disclosure through logs. AI analysis will determine if sensitive data is likely present in the logged content."
      remediation: "Sanitize query engine responses before logging. Remove or redact sensitive information (PII, secrets, API keys). Use structured logging with field filtering. Implement log access controls and encryption."
      ai_analysis_recommended: true
      examples:
        vulnerable: "samples/llamaindex_sensitive_info.py"
      references:
        - "https://owasp.org/www-project-top-10-for-large-language-model-applications/"
        - "https://cwe.mitre.org/data/definitions/200.html"
    paths:
      include:
        - "*.py"

  - id: llamaindex-llm06-index-content-logging
    patterns:
      - pattern-either:
          # Index content logging
          - pattern: |
              $DOCS = $LOADER.load_data()
              ...
              logger.info($DOCS)
          - pattern: |
              $INDEX = VectorStoreIndex.from_documents($DOCS)
              ...
              logger.debug($DOCS)
          - pattern: |
              $RESULT = $INDEX.query(...)
              ...
              logger.info($RESULT)
    message: "LLM06: Sensitive Information Disclosure - Index content or documents logged without sanitization"
    severity: WARNING
    languages: [python]
    metadata:
      category: security
      subcategory: data-exposure
      owasp: "LLM06"
      owasp-title: "Sensitive Information Disclosure"
      owasp-url: "https://owasp.org/www-project-top-10-for-large-language-model-applications/LLM_Top_10/LLM06.html"
      cwe: ["CWE-200", "CWE-532"]
      cwe-url: ["https://cwe.mitre.org/data/definitions/200.html", "https://cwe.mitre.org/data/definitions/532.html"]
      tags: ["owasp", "llm06", "sensitive-info-disclosure", "logging", "index", "llamaindex", "ai-enhanced"]
      technology: ["python", "llamaindex", "llm"]
      confidence: "medium"  # Medium confidence - depends on what's logged
      impact: "medium"
      likelihood: "medium"  # AI will assess if sensitive data is present
      description: "Index content, documents, or query results are logged without sanitization. If documents contain sensitive data (PII, secrets, API keys), this can lead to information disclosure through logs. AI analysis will determine if sensitive data is likely present."
      remediation: "Sanitize all document and index content before logging. Remove or redact sensitive information (PII, secrets, API keys). Use structured logging with field filtering. Implement log access controls and encryption."
      ai_analysis_recommended: true
      examples:
        vulnerable: "samples/llamaindex_sensitive_info.py"
      references:
        - "https://owasp.org/www-project-top-10-for-large-language-model-applications/"
        - "https://cwe.mitre.org/data/definitions/200.html"
    paths:
      include:
        - "*.py"
