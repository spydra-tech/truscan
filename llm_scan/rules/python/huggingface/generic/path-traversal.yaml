rules:
  # ============================================================================
  # LLM02: Path Traversal - Hugging Face Pipeline Output
  # ============================================================================
  # Detects path traversal vulnerabilities where pipeline output is used
  # in file operations without validation
  # 
  # Usage with AI:
  #   python -m llm_scan.runner . --enable-ai-filter \
  #     --ai-analyze-rules huggingface-llm02-pipeline-to-file-ops
  #
  # OWASP: LLM02
  # CWE: CWE-22
  # ============================================================================

  - id: huggingface-llm02-pipeline-to-file-ops
    mode: taint
    pattern-sources:
      - pattern: |
          pipeline(...)
      - pattern: |
          $PIPELINE(...)
      - pattern: |
          TextGenerationPipeline(...)(...)
    pattern-sinks:
      - pattern: |
          open($PIPELINE_OUTPUT, ...)
      - pattern: |
          os.remove($PIPELINE_OUTPUT)
      - pattern: |
          os.unlink($PIPELINE_OUTPUT)
      - pattern: |
          shutil.copy($PIPELINE_OUTPUT, ...)
      - pattern: |
          shutil.move($PIPELINE_OUTPUT, ...)
      - pattern: |
          Path($PIPELINE_OUTPUT).write_text(...)
    message: "LLM02: Path Traversal - Pipeline output used in file operations without validation"
    severity: WARNING
    languages: [python]
    metadata:
      category: security
      subcategory: path-traversal
      owasp: "LLM02"
      owasp-title: "Insecure Output Handling (Path Traversal)"
      owasp-url: "https://owasp.org/www-project-top-10-for-large-language-model-applications/LLM_Top_10/LLM02.html"
      cwe: ["CWE-22"]
      cwe-url: ["https://cwe.mitre.org/data/definitions/22.html"]
      tags: ["owasp", "llm02", "path-traversal", "pipeline", "huggingface", "taint", "ai-enhanced"]
      technology: ["python", "huggingface", "transformers", "llm"]
      confidence: "medium"  # Medium confidence - depends on path validation
      impact: "high"
      likelihood: "medium"  # AI will assess if path validation is present
      description: "Pipeline output is used in file operations. If the output contains file paths, this can lead to path traversal attacks. AI analysis will determine if path validation is present."
      remediation: "Validate and sanitize all file paths before use. Restrict file operations to specific directories. Use os.path.abspath() and os.path.join() for safe path construction. Implement path allowlisting."
      ai_analysis_recommended: true
      examples:
        vulnerable: "samples/huggingface_path_traversal.py"
      references:
        - "https://owasp.org/www-project-top-10-for-large-language-model-applications/"
        - "https://cwe.mitre.org/data/definitions/22.html"
    paths:
      include:
        - "*.py"
