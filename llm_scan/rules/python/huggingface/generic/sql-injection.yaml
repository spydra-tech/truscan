rules:
  # ============================================================================
  # LLM02: SQL Injection - Hugging Face Pipeline Output
  # ============================================================================
  # Detects SQL injection vulnerabilities where pipeline output is used
  # in SQL queries without parameterization
  # 
  # Usage with AI:
  #   python -m llm_scan.runner . --enable-ai-filter \
  #     --ai-analyze-rules huggingface-llm02-pipeline-to-sql
  #
  # OWASP: LLM02
  # CWE: CWE-89
  # ============================================================================

  - id: huggingface-llm02-pipeline-to-sql
    mode: taint
    pattern-sources:
      - pattern: |
          pipeline(...)
      - pattern: |
          $PIPELINE(...)
      - pattern: |
          TextGenerationPipeline(...)(...)
      - pattern: |
          QuestionAnsweringPipeline(...)(...)
    pattern-sinks:
      - pattern: |
          $CURSOR.execute(f"...{$PIPELINE_OUTPUT}...")
      - pattern: |
          $DB.execute(f"...{$PIPELINE_OUTPUT}...")
      - pattern: |
          $SESSION.execute(f"...{$PIPELINE_OUTPUT}...")
      - pattern: |
          $CURSOR.execute("..." + $PIPELINE_OUTPUT + "...")
      - pattern: |
          $DB.execute("..." + $PIPELINE_OUTPUT + "...")
      - pattern: |
          $CURSOR.execute("...{}...".format($PIPELINE_OUTPUT))
      - pattern: |
          $CURSOR.execute("...%s..." % $PIPELINE_OUTPUT)
    message: "LLM02: SQL Injection - Pipeline output concatenated into SQL query without parameterization"
    severity: ERROR
    languages: [python]
    metadata:
      category: security
      subcategory: sql-injection
      owasp: "LLM02"
      owasp-title: "Insecure Output Handling (SQL Injection)"
      owasp-url: "https://owasp.org/www-project-top-10-for-large-language-model-applications/LLM_Top_10/LLM02.html"
      cwe: ["CWE-89"]
      cwe-url: ["https://cwe.mitre.org/data/definitions/89.html"]
      tags: ["owasp", "llm02", "sql-injection", "pipeline", "huggingface", "taint", "ai-enhanced"]
      technology: ["python", "huggingface", "transformers", "llm"]
      confidence: "high"
      impact: "critical"
      likelihood: "high"
      description: "Pipeline output is concatenated into SQL queries using string formatting (f-strings, .format(), % formatting). This can lead to SQL injection if the pipeline output contains malicious SQL code."
      remediation: "Always use parameterized queries instead of string concatenation. Validate and sanitize pipeline output before SQL execution. Use SQL query builders or ORMs that support parameterized queries. Never trust pipeline output in SQL queries."
      ai_analysis_recommended: true
      examples:
        vulnerable: "samples/huggingface_sql_injection.py"
      references:
        - "https://owasp.org/www-project-top-10-for-large-language-model-applications/"
        - "https://cwe.mitre.org/data/definitions/89.html"
    paths:
      include:
        - "*.py"
