rules:
  # ============================================================================
  # LLM02: Insecure Output Handling - SQL Injection (OpenAI Generic)
  # ============================================================================
  # Detects LLM output used in SQL queries without parameterization
  # OWASP: LLM02
  # CWE: CWE-89
  # ============================================================================

  - id: openai-sql-injection-string-format
    patterns:
      - pattern-either:
          - pattern: |
              $RESPONSE = openai.ChatCompletion.create(...)
          - pattern: |
              $RESPONSE = openai.Completion.create(...)
          - pattern: |
              $RESPONSE = $CLIENT.chat.completions.create(...)
      - pattern-inside: |
          $QUERY = $RESPONSE.choices[0].message.content
          ...
      - pattern-either:
          # f-strings
          - pattern: |
              $DB.execute(f"...{$QUERY}...")
          - pattern: |
              $CURSOR.execute(f"...{$QUERY}...")
          - pattern: |
              $SESSION.execute(f"...{$QUERY}...")
          # String concatenation
          - pattern: |
              $DB.execute("..." + $QUERY + "...")
          - pattern: |
              $CURSOR.execute("..." + $QUERY + "...")
          # .format() method
          - pattern: |
              $DB.execute("...{}...".format($QUERY))
          - pattern: |
              $CURSOR.execute("...{}...".format($QUERY))
          # % formatting
          - pattern: |
              $DB.execute("...%s..." % $QUERY)
          - pattern: |
              $CURSOR.execute("...%s..." % $QUERY)
          # Template strings with named params
          - pattern: |
              $DB.execute("...{query}...".format(query=$QUERY))
          - pattern: |
              $CURSOR.execute("...{query}...".format(query=$QUERY))
    message: "LLM02: Insecure Output Handling - OpenAI output concatenated into SQL query (SQL injection risk)"
    severity: ERROR
    languages: [python]
    metadata:
      category: security
      subcategory: sql-injection
      owasp: "LLM02"
      owasp-title: "Insecure Output Handling"
      owasp-url: "https://owasp.org/www-project-top-10-for-large-language-model-applications/LLM_Top_10/LLM02.html"
      cwe: ["CWE-89"]
      cwe-url: ["https://cwe.mitre.org/data/definitions/89.html"]
      tags: ["owasp", "llm02", "insecure-output", "sql-injection", "llm", "ai-security", "openai", "string-concatenation"]
      technology: ["python", "openai", "llm"]
      confidence: "high"
      impact: "critical"
      likelihood: "high"
      description: "OpenAI output is concatenated into SQL queries using string formatting (f-strings, +, .format(), %), allowing SQL injection attacks. This pattern is always dangerous regardless of validation. Detects multiple string formatting methods."
      remediation: "Use parameterized queries with placeholders. Never concatenate user input or LLM output into SQL queries."
      examples:
        vulnerable: "samples/llm02_insecure_output.py"
      references:
        - "https://owasp.org/www-project-top-10-for-large-language-model-applications/"
        - "https://owasp.org/www-community/attacks/SQL_Injection"
        - "https://cwe.mitre.org/data/definitions/89.html"
    paths:
      include:
        - "**/*.py"
