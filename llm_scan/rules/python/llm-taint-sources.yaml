rules:
  - id: llm-taint-openai-legacy
    patterns:
      - pattern-either:
          - pattern: openai.ChatCompletion.create(...)
          - pattern: openai.Completion.create(...)
      - pattern-inside: |
          $RESPONSE = ...
          $CONTENT = $RESPONSE.choices[0].message.content
          ...
          $SINK($CONTENT)
    message: "OpenAI legacy API response content flows to dangerous sink"
    severity: WARNING
    languages: [python]
    metadata:
      category: security
      subcategory: taint-analysis
      cwe: ["CWE-94"]
      cwe-url: ["https://cwe.mitre.org/data/definitions/94.html"]
      tags: ["taint-source", "openai", "legacy-api", "llm", "ai-security", "data-flow"]
      technology: ["python", "openai", "llm"]
      confidence: "high"
      impact: "medium"
      likelihood: "medium"
      description: "OpenAI legacy API (ChatCompletion/Completion) response content flows to a potentially dangerous sink function, indicating a taint flow vulnerability."
      remediation: "Validate and sanitize LLM output before using in dangerous operations. Implement proper input validation and output sanitization."
      examples:
        vulnerable: "samples/vulnerable_app.py"
      references:
        - "https://owasp.org/www-community/vulnerabilities/Code_Injection"
        - "https://cwe.mitre.org/data/definitions/94.html"
    paths:
      include:
        - "*.py"

  - id: llm-taint-openai-v1
    patterns:
      - pattern-either:
          - pattern: $CLIENT.chat.completions.create(...)
          - pattern: $CLIENT.completions.create(...)
      - pattern-inside: |
          $RESPONSE = ...
          $CONTENT = $RESPONSE.choices[0].message.content
          ...
          $SINK($CONTENT)
    message: "OpenAI v1 API response content flows to dangerous sink"
    severity: WARNING
    languages: [python]
    metadata:
      category: security
      subcategory: taint-analysis
      cwe: ["CWE-94"]
      cwe-url: ["https://cwe.mitre.org/data/definitions/94.html"]
      tags: ["taint-source", "openai", "v1-api", "llm", "ai-security", "data-flow"]
      technology: ["python", "openai", "llm"]
      confidence: "high"
      impact: "medium"
      likelihood: "medium"
      description: "OpenAI v1 API (client.chat.completions.create) response content flows to a potentially dangerous sink function, indicating a taint flow vulnerability."
      remediation: "Validate and sanitize LLM output before using in dangerous operations. Implement proper input validation and output sanitization."
      examples:
        vulnerable: "samples/vulnerable_app.py"
      references:
        - "https://owasp.org/www-community/vulnerabilities/Code_Injection"
        - "https://cwe.mitre.org/data/definitions/94.html"
    paths:
      include:
        - "*.py"

  - id: llm-taint-anthropic
    patterns:
      - pattern: $CLIENT.messages.create(...)
      - pattern-inside: |
          $RESPONSE = ...
          $CONTENT = $RESPONSE.content[0].text
          ...
          $SINK($CONTENT)
    message: "Anthropic API response content flows to dangerous sink"
    severity: WARNING
    languages: [python]
    metadata:
      category: security
      subcategory: taint-analysis
      cwe: ["CWE-94"]
      cwe-url: ["https://cwe.mitre.org/data/definitions/94.html"]
      tags: ["taint-source", "anthropic", "llm", "ai-security", "data-flow"]
      technology: ["python", "anthropic", "llm"]
      confidence: "high"
      impact: "medium"
      likelihood: "medium"
      description: "Anthropic API (client.messages.create) response content flows to a potentially dangerous sink function, indicating a taint flow vulnerability."
      remediation: "Validate and sanitize LLM output before using in dangerous operations. Implement proper input validation and output sanitization."
      examples:
        vulnerable: "samples/vulnerable_app.py"
      references:
        - "https://owasp.org/www-community/vulnerabilities/Code_Injection"
        - "https://cwe.mitre.org/data/definitions/94.html"
    paths:
      include:
        - "*.py"

  - id: llm-taint-generic-wrapper
    patterns:
      - pattern-either:
          - pattern: call_llm(...)
          - pattern: $OBJ.llm(...)
          - pattern: $OBJ.generate(...)
          - pattern: $OBJ.chat(...)
          - pattern: llm(...)
      - pattern-inside: |
          $RESPONSE = ...
          $TEXT = $RESPONSE.text
          ...
          $SINK($TEXT)
    message: "Generic LLM wrapper response flows to dangerous sink"
    severity: WARNING
    languages: [python]
    metadata:
      category: security
      subcategory: taint-analysis
      cwe: ["CWE-94"]
      cwe-url: ["https://cwe.mitre.org/data/definitions/94.html"]
      tags: ["taint-source", "generic-wrapper", "llm", "ai-security", "data-flow"]
      technology: ["python", "llm"]
      confidence: "medium"
      impact: "medium"
      likelihood: "medium"
      description: "Generic LLM wrapper function (call_llm, .llm(), .generate(), .chat()) response content flows to a potentially dangerous sink function, indicating a taint flow vulnerability."
      remediation: "Validate and sanitize LLM output before using in dangerous operations. Implement proper input validation and output sanitization."
      examples:
        vulnerable: "samples/vulnerable_app.py"
      references:
        - "https://owasp.org/www-community/vulnerabilities/Code_Injection"
        - "https://cwe.mitre.org/data/definitions/94.html"
    paths:
      include:
        - "*.py"
