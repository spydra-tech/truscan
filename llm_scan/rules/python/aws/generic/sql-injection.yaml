rules:
  # ============================================================================
  # LLM02: Insecure Output Handling - SQL Injection (AWS Bedrock Generic)
  # ============================================================================
  # Detects LLM output used in SQL queries without parameterization
  # OWASP: LLM02
  # CWE: CWE-89
  # ============================================================================

  - id: aws-sql-injection-string-format
    patterns:
      - pattern-either:
          - pattern: |
              $RESPONSE = $BEDROCK.converse(...)
          - pattern: |
              $RESPONSE = $CLIENT.converse(...)
          - pattern: |
              $RESPONSE = $BEDROCK.invoke_model(...)
          - pattern: |
              $RESPONSE = $CLIENT.invoke_model(...)
      - pattern-inside: |
          $BODY = json.loads($RESPONSE['body'].read())
          ...
          $QUERY = $BODY['output']['message']['content'][0]['text']
          ...
      - pattern-inside: |
          $BODY = json.loads($RESPONSE['body'].read())
          ...
          $QUERY = $BODY['completion']
          ...
      - pattern-either:
          # f-strings
          - pattern: |
              $DB.execute(f"...{$QUERY}...")
          - pattern: |
              $CURSOR.execute(f"...{$QUERY}...")
          - pattern: |
              $SESSION.execute(f"...{$QUERY}...")
          # String concatenation
          - pattern: |
              $DB.execute("..." + $QUERY + "...")
          - pattern: |
              $CURSOR.execute("..." + $QUERY + "...")
          # .format() method
          - pattern: |
              $DB.execute("...{}...".format($QUERY))
          - pattern: |
              $CURSOR.execute("...{}...".format($QUERY))
          # % formatting
          - pattern: |
              $DB.execute("...%s..." % $QUERY)
          - pattern: |
              $CURSOR.execute("...%s..." % $QUERY)
          # Template strings with named params
          - pattern: |
              $DB.execute("...{query}...".format(query=$QUERY))
          - pattern: |
              $CURSOR.execute("...{query}...".format(query=$QUERY))
    message: "LLM02: Insecure Output Handling - AWS Bedrock output concatenated into SQL query (SQL injection risk)"
    severity: ERROR
    languages: [python]
    metadata:
      category: security
      subcategory: sql-injection
      owasp: "LLM02"
      owasp-title: "Insecure Output Handling"
      owasp-url: "https://owasp.org/www-project-top-10-for-large-language-model-applications/LLM_Top_10/LLM02.html"
      cwe: ["CWE-89"]
      cwe-url: ["https://cwe.mitre.org/data/definitions/89.html"]
      tags: ["owasp", "llm02", "insecure-output", "sql-injection", "llm", "ai-security", "aws", "bedrock", "string-concatenation"]
      technology: ["python", "aws", "bedrock", "boto3", "llm"]
      confidence: "high"
      impact: "critical"
      likelihood: "high"
      description: "AWS Bedrock output is concatenated into SQL queries using string formatting (f-strings, +, .format(), %), allowing SQL injection attacks. This pattern is always dangerous regardless of validation. Detects multiple string formatting methods."
      remediation: "Use parameterized queries with placeholders. Never concatenate user input or LLM output into SQL queries."
      ai_analysis_recommended: false
      examples:
        vulnerable: "samples/aws_bedrock_sql_injection.py"
      references:
        - "https://owasp.org/www-project-top-10-for-large-language-model-applications/"
        - "https://owasp.org/www-community/attacks/SQL_Injection"
        - "https://cwe.mitre.org/data/definitions/89.html"
    paths:
      include:
        - "**/*.py"

  - id: aws-sql-injection-taint
    mode: taint
    pattern-sources:
      - pattern: |
          $BEDROCK.converse(...)
      - pattern: |
          $CLIENT.converse(...)
      - pattern: |
          $BEDROCK.invoke_model(...)
      - pattern: |
          $CLIENT.invoke_model(...)
      - pattern: |
          boto3.client('bedrock-runtime').converse(...)
    pattern-sinks:
      - pattern: |
          $CURSOR.execute(f"...{$BEDROCK_OUTPUT}...")
      - pattern: |
          $DB.execute(f"...{$BEDROCK_OUTPUT}...")
      - pattern: |
          $SESSION.execute(f"...{$BEDROCK_OUTPUT}...")
      - pattern: |
          $CURSOR.execute("..." + $BEDROCK_OUTPUT + "...")
      - pattern: |
          $DB.execute("..." + $BEDROCK_OUTPUT + "...")
      - pattern: |
          $CURSOR.execute("...{}...".format($BEDROCK_OUTPUT))
      - pattern: |
          $CURSOR.execute("...%s..." % $BEDROCK_OUTPUT)
    message: "LLM02: SQL Injection - AWS Bedrock output flows into SQL queries without parameterization"
    severity: ERROR
    languages: [python]
    metadata:
      category: security
      subcategory: sql-injection
      owasp: "LLM02"
      owasp-title: "Insecure Output Handling"
      owasp-url: "https://owasp.org/www-project-top-10-for-large-language-model-applications/LLM_Top_10/LLM02.html"
      cwe: ["CWE-89"]
      cwe-url: ["https://cwe.mitre.org/data/definitions/89.html"]
      tags: ["owasp", "llm02", "insecure-output", "sql-injection", "llm", "ai-security", "aws", "bedrock", "taint", "ai-enhanced"]
      technology: ["python", "aws", "bedrock", "boto3", "llm"]
      confidence: "high"
      impact: "critical"
      likelihood: "high"
      description: "AWS Bedrock output flows into SQL queries using string formatting. This can lead to SQL injection if the LLM output contains malicious SQL code."
      remediation: "Always use parameterized queries instead of string concatenation. Validate and sanitize LLM output before SQL execution. Use SQL query builders or ORMs that support parameterized queries."
      ai_analysis_recommended: false
      examples:
        vulnerable: "samples/aws_bedrock_sql_injection.py"
      references:
        - "https://owasp.org/www-project-top-10-for-large-language-model-applications/"
        - "https://cwe.mitre.org/data/definitions/89.html"
    paths:
      include:
        - "**/*.py"
