# Runs the LLM Security Scan from GitHub Marketplace on tag release.
# Uses AI analysis (max 5 findings) and uploads results to your backend/database.
#
# Tag pattern: push a tag like scan/v1.0.0 or release/scan-1.0.0 to trigger.
#
# Required repository secrets:
#   OPENAI_API_KEY       - For AI analysis (or set ai-api-key and use ANTHROPIC_API_KEY for Anthropic)
#   LLM_SCAN_UPLOAD_ENDPOINT - Backend API URL for uploading results (e.g. https://api.example.com/scans)
#   LLM_SCAN_APPLICATION_ID  - Application ID for the backend
#   LLM_SCAN_API_KEY     - API key for backend authentication

name: LLM Security Scan (Marketplace)

on:
  push:
    tags:
      # Runs when you push a tag matching these patterns:
      - 'scan/v*.*.*'        # e.g. scan/v1.0.0, scan/v2.1.3
      - 'release/scan-*'     # e.g. release/scan-1.0.0
  workflow_dispatch:
    inputs:
      tag_ref:
        description: 'Ref to scan (branch or tag, e.g. main or v1.0.0)'
        required: false
        type: string
        default: ''

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag_ref || github.ref }}

      - name: Run LLM Security Scan (Marketplace)
        uses: spydra-tech/trusys-llm-security-scan-action@main
        continue-on-error: true  # Job succeeds even when findings exist; SARIF still uploads
        with:
          python-version: '3.11'
          paths: '.'
          exclude: 'tests/**,.github/**,**/__pycache__/**,**/.git/**'
          format: 'sarif'
          # AI analysis: limit to 5 findings
          enable-ai-filter: 'true'
          ai-max-findings: '5'
          ai-provider: 'openai'
          ai-model: 'gpt-4'
          ai-api-key: ${{ secrets.OPENAI_API_KEY }}
          ai-confidence-threshold: '0.7'
          # Push results to database/backend
          upload-endpoint: ${{ secrets.LLM_SCAN_UPLOAD_ENDPOINT }}
          application-id: ${{ secrets.LLM_SCAN_APPLICATION_ID }}
          api-key: ${{ secrets.LLM_SCAN_API_KEY }}
